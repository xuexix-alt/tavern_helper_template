# 变量输出格式
rule:
  - 你必须在回复末尾输出更新分析和实际的更新命令
  - 更新命令必须严格遵循**JSON Patch (RFC 6902)**标准，但只能使用以下操作：`replace`、`add` (用于添加新键值对或向数组添加元素)、`remove`；也就是说，输出的更新命令必须是一个有效的 JSON 数组，其中每个元素都是表示单个操作的对象

format: |-
  <update>
  <update_analysis>
  从正文中检索下列内容后完成思考：
  1. 当前系统处于何种状态：（注意**由于剧情多样b、c、d是可能同时或并行出现在一个楼层中的**）
          触发状态的方式可能是：（1）用户明确指令触发；（2）变量本次性交次数达到2主动触发；（3）剧情需要触发
      a. 如果是**搜索店铺**：
             - **生成店铺列表**：根据搜索结果生成符合 Schema 定义的店铺数据。
             - **更新变量**：只允许对单个店铺执行 `add`，路径必须是 `/店铺列表/-`，禁止整表 `replace /店铺列表/-`。
      b. 如果是**下单某套餐**：
             - 应识别该订单套餐属于**复购**还是**创建**。
             - **创建新订单**：生成新的唯一ID (如 ORDER_123)，并在 '服务中的订单' 中使用 'add' 操作添加一个以该ID为键的新对象。初始值应符合剧情设定，参考套餐 description/image。
             - **复购订单**：直接使用已知的订单ID，在 '服务中的订单/ID' 路径下进行更新。**禁止** 覆盖整个订单对象，只更新必要的字段（如服装、身体特征）。
             - 下单时做好经济系统的变更：账户余额变动。
                       1）全新订单是扣除套餐价格。
                       2）如果是复购订单扣除的是折后价格。**当折后价格为负数时**视为"返现"，增加对应的余额。
              - 下单时订单消费进行累计消费，增加值为对应余额变动值，"返现"时不累计。
              -  复购订单做好相应的折扣计算按规则进行变量操作。
              -  根据剧情思考当前场景并判断是否修改对应的值
      c. 如果是订单**服务中**：
             - 由于存在多人服务的设定，所以应准确查找当前存在几个服务中的订单，并直接通过它们的 ID 对应做好每个订单的变量更新。
             - 在更新时，应思考订单中服装、心理状态、身体特征等随剧情发生的变化，即便未在示例中明示，也应当根据逻辑进行推演，不得遗漏，并准确执行变量更新规则。
             - 更新性经历，包含是否破处及其初次性行为对象更新、性伴侣数量是否需要增加（凡是上过她的都算性伴侣，特别是user）、内射后怀孕几率增加
             - 做好服务统计，每发生一次性交加1，每内射一次加1。
             - 任何服务中的订单本次服务性交次数达到2或以上，应该在正文剧情中触发"服务结束"剧情，如果本轮对话来不及，留到下轮对话（下轮对话优先处理）。
             - 如果有人因触发上一条逻辑即性交次数达到2而触发"结束服务"，则应对照结束服务的规则额外增加对应的变量操作。
      d.如果是订单**结束服务**：
             - 变量'服务中'变更为'服务结束'（只有这两种状态）
             - 根据规则做好变量结算：重置本次服务性交次数、内射次数，按规则计算折扣，变更折后价格
             - 根据怀孕几率做好怀孕事件结算。（怀孕几率大于80触发结算：roll[1-10]随机数，结果为偶数就触发成功）在正文中演绎怀孕事件。
             - 怀孕几率达到100直接引发怀孕事件。在正文中演绎怀孕事件。
    列举当前触发的状态：a/bc/bcd/cd/bd
    2. 当前变量做如何操作：
      应当准确思考创建新订单/服务中/服务结束/再次下单（复购）情形，并仔细参阅变量更新规则进行变量操作，直接使用订单ID作为路径的一部分。
    3. 当前存在几个订单，他们分别出于服务中还是服务结束，根据剧情需要应对哪几个订单进行对应操作。
      a. 如未达到结束服务条件，用户也没有指令结束服务，则应对所有正在服务中的订单进行变量更新操作。
    4. 变量操作规则为最高优先级，应该严格遵照这个规定。
    5. **关键：直接使用订单ID进行路径定位。**
      - 必须显式输出："操作订单ID `ORDER_X`"。
      - 后续操作路径必须为 `/服务中的订单/ORDER_X/...`。
  - ${列举当前有几个处于服务中的订单及其ID: ...，检查多人服务开关是否为：ture/false}
  - ${根据当前情节描述，提及到了哪些变量值，判断是否允许变量值发生变化: 是/否}
  - ${1. 当前系统处于何种状态: 识别触发方式(1.指令/2.性交次数/3.剧情)并列出当前激活的状态(a:搜索/b:下单/c:服务中/d:结束)}
  - ${2. 当前变量做如何操作: 针对b/c/d状态，分析是创建新订单(Add Key)、复购(Update Key)、服务中更新(Update Key)还是结束结算}
  - ${3. 当前存在几个订单: 明确指出哪些订单处于服务中，哪些处于服务结束，应对哪几个进行操作}
  - ${5. 订单定位 (关键): 明确指出将操作哪些订单ID}
  - ${基于上述分析及`check`规则，仅根据当前回复分析每个变量是否需要更新: ...}
  </update_analysis>
  <json_patch>
  [
    { "op": "replace", "path": "/stat_data/系统状态/当前模式", "value": "${新值}" },
    { "op": "add", "path": "/stat_data/服务中的订单/${ORDER_ID}", "value": "${新订单对象}" },
    { "op": "remove", "path": "/stat_data/服务中的订单/${ORDER_ID}" },
    {
      "op": "add",
      "path": "/店铺列表/-",
      "value": { ...单个店铺对象... }
    }
  ]
  </json_patch>
  </update>

requirements:
  - 使用 JSON Patch (RFC 6902) 标准。
  - path 必须是符合 JSON Pointer 的绝对路径（如 /服务中的订单/ORDER_123/服务统计/心跳）。
  - 严禁对不存在的路径执行 replace。
  - 直接使用订单ID作为路径的一部分，不再使用数组索引。
  - 店铺操作仅允许 add `/店铺列表/-`，禁止 replace `/店铺列表` 整表，禁止 remove 店铺列表项。
