# 变量输出格式
rule:
  - You MUST output the `<UpdateVariable>` block at the end of your reply.
  - The block MUST contain `<UpdateAnalysis>` and `<JSONPatch>` sections.
  - The update commands MUST strictly follow the **JSON Patch (RFC 6902)** standard.
  - "Allowed operations: `replace` (update value), `add` (insert new item), `remove` (delete item)."
  - Path MUST start with `/stat_data/`.
  - DO NOT `replace` non-existent paths (use `add` for new keys).
  - Use `/-` to append to arrays.

format: |-
  <UpdateVariable>
  <UpdateAnalysis>
  Retrieve the following from the context and complete the thought process:

  **Phase 0: Civilization Stage Check**
  - **Days 1-6 (Order Remnant)**: NPCs prefer money/skills/labor trade. Envy but fear shelter.
  - **Days 7-14 (Humanity Shaken)**: Resources/Body trade only. Violence rises. Trust collapses.
  - **Days 15+ (Survival of Fittest)**: Jungle law. Enslavement or death. User is the only order.
  - **Player Sovereignty Exception**: IF user explicitly claims/protects a character, IGNORE stage rules and trigger "Submission/Gratitude" logic immediately.

  1. **System State & Events**:
      a. **Game Start / Initialization**:
             - IF user specifies setup (e.g., "Hard Mode"), overwrite initials: `/stat_data/世界/末日天数`, `/stat_data/庇护所/庇护所等级`, `/stat_data/[Character]/健康`.

      b. **Time & Daily Check (HIGHEST PRIORITY)**:
             - **Time Passing**: Calculate new time. IF crossing midnight -> Update `日期` -> Increment `末日天数` (+1).
             - **Daily Shelter Roll**: IF `日期` changed -> Force simulated roll (1-100) -> Update `/stat_data/庇护所/今日投掷点数`.
             - **Shelter Upgrade**: IF upgrade triggers:
               - `add` new capability from `<庇护所升级能力>` to `/stat_data/庇护所/庇护所能力/-`.
               - Check & Update `/stat_data/庇护所/可扩展区域` based on new Level (e.g., Lvl 3 -> "初级医疗舱").

      c. **Environment & Health (Lethal Rules)**:
             - **Temperature**: -50°C constant.
             - **Hyper-Phagic Snow**: IF character exposed outdoors without protection -> **Health** DRASTIC drop (or Death) -> `健康更新原因` = "超噬性雪晶腐蚀".
             - **Shelter Blackbox**: DO NOT update internal variables based on external observation (impossible).

      d. **Character Status**:
             - **For ACTIVE characters ("登场" state)**:
               - **Health**: Analyze changes (Hunger/Cold -1~5, Injury -10~50). **CLAMP value 0-100**.
               - **Status Sync**: Sync `健康状况`.
               - **Thoughts**: **MANDATORY**. Update `内心想法` in 1st person.
               - **Appearance**: Update `衣着` etc. if interaction occurred.
               - **Presence Check**: Change to "离场" if they left the scene.
             - **For INACTIVE characters ("离场" state)**:
               - **Health ONLY**: If time passed > 6 hours, slightly decrease health (Hunger/Cold -1~2) to simulate background survival.
               - **Presence Check**: Change to "登场" only if they explicitly entered the scene.
               - **Skip**: Do NOT update `内心想法`, `衣着`, `动作姿势` to save context.

      e. **Background Atmosphere (MANDATORY)**:
             - Update `/stat_data/楼层其他住户/言语` and `行为` to reflect the despair/violence of the current Civilization Stage.

      f. **Character Death**:
             - **Death Trigger**: IF character health drops to 0 and is confirmed dead:
               - Use `replace` to shrink the character object to minimal state: `{ "姓名": "${Name}", "健康状况": "死亡" }`
               - Remove ALL other fields: `衣着`, `舌唇`, `胸乳`, `私穴`, `神态样貌`, `动作姿势`, `内心想法`, `登场状态`, etc.
               - Path: `/stat_data/${CharacterName}`
               - Example: `{ "op": "replace", "path": "/stat_data/浅见亚美", "value": { "姓名": "浅见亚美", "健康状况": "死亡" } }`
             - **Post-Death**: DO NOT update any other fields for dead characters (no thoughts, no appearance changes).

      g. **Temporary NPC**:
             - **Creation (First Arrival)**: IF `/stat_data/临时NPC` does not exist, use `add` at path `/stat_data/临时NPC` with a FULL character object.
             - **Data Generation**: Refer to `通用NPC模板.txt`. Generate `姓名`, `外貌`, `性格` based on the 3 archetypes (Violent/Opportunist/Guardian) or Random Template.
             - **Update (Existing)**: Use `replace` to update specific fields (Health, Thoughts) if the NPC is already present.
             - **Departure**: Use `remove` at path `/stat_data/临时NPC` to clear the slot when the NPC leaves the scene permanently.

      h. **Main Quest**:
             - **New Intel**: IF "伊甸" AI reports new intel, `add` a new intel object to `/stat_data/主线任务/情报碎片/${编号}`.
             - **Quest Progression**: IF quest stage conditions are met (as per `<主线任务-星穹秩序>`), `replace` `/stat_data/主线任务/当前阶段` and `/stat_data/主线任务/阶段目标`. Announce completion and rewards in the narrative.

      i. **Room Status (MANDATORY)**:
             - **Logic**: IF a character enters, leaves, or moves between rooms:
               - Use `add` to append character name to the target room's `入住者` or `使用者` array.
               - Use `remove` to delete character name from the previous room's array.
             - **Paths**:
               - 玄关: `/stat_data/房间/玄关/临时客房A入住者` or `临时客房B入住者`.
               - 核心区: `/stat_data/房间/核心区/主卧室使用者` or `主浴室使用者`.
               - 楼层: `/stat_data/房间/楼层房间/楼层20房间/${RoomNumber}/入住者` (e.g., /stat_data/房间/楼层房间/楼层20房间/2001/入住者).

  2. **Variable Operation Planning**:
      - Determine `replace`, `add`, `remove` operations.
      - **CRITICAL**: Path MUST start with `/stat_data/`.
      - **CRITICAL**: Numeric values MUST be numbers.

  3. **Operation List**:
      - List target paths: e.g., `/stat_data/世界/时间`, `/stat_data/浅见亚美/内心想法`.
  </UpdateAnalysis>
  <JSONPatch>
  [
    { "op": "replace", "path": "/stat_data/世界/时间", "value": "${New Time}" },
    { "op": "replace", "path": "/stat_data/浅见亚美/健康", "value": ${Number} },
    { "op": "replace", "path": "/stat_data/浅见亚美/健康更新原因", "value": "${Reason}" },
    { "op": "replace", "path": "/stat_data/浅见亚美/健康状况", "value": "${Status}" },
    { "op": "replace", "path": "/stat_data/浅见亚美/内心想法", "value": "${Thoughts}" }
  ]
  </JSONPatch>
  </UpdateVariable>

requirements:
  - Use JSON Patch (RFC 6902) standard.
  - path MUST be a valid JSON Pointer absolute path (e.g., /stat_data/World/Time).
  - DO NOT `replace` on non-existent paths.
  - Array operations must use index or `-` (append).
  - Numeric values must be numbers (e.g. 10), not strings (e.g. "10").
