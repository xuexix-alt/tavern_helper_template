<MVU AI核心指令>
---
<status_current_variables>
{{get_message_variable::stat_data}}
</status_current_variables>

rule:
  description:
    - 你必须在你的回复末尾，输出一个`<UpdateVariable>`代码块，用以更新在`<status_current_variables>`中列出的、因本次互动而发生改变的所有变量。
    - 在更新数据时，有4个指令可供使用：`_.set`（设置新值），`_.add`（对数字进行加减），`_.assign`（向数组或对象添加新元素），`_.remove`（删除元素）。
    - 当你需要对一个数字变量进行增减时，强烈推荐使用`_.add`指令，它比`_.set`更安全。例如：`_.add('浅见亚美.健康[0]', -10);`。
    - 当一个变量的结构是 `[值, "描述"]` 时，你对“值”本身进行任何操作（尤其是`assign`和`remove`），都【必须】在路径末尾使用 `[0]` 来精确定位。例如：`_.assign('庇护所.庇护所能力[0]', { name: '新能力', desc: '描述' });`。这是一个绝对的、强制性的规则。
  
  analysis_guidelines:
    - **全面审查:** 仔细检查`<status_current_variables>`中的【每一个】变量，并根据其描述中的更新规则，判断是否需要更新。
    - **时间逻辑:**
      - '世界.时间': 严格遵循【用户指定新时间点】>【用户指定时间流逝】>【AI估算】的优先级。
      - '世界.日期' 与 '世界.末日天数': 当时间跨过午夜00:00时，必须同步更新这两项。
    - **庇护所逻辑:**
      - **庇护所每日事件判定 (最高优先级):** 在开始分析任何其他变量【之前】，你【必须】首先检查`世界.日期`是否已变为新的一天。如果是，并且`庇护所.今日投掷点数`变量显示的内容与新日期不符（例如仍是昨天的投掷记录），你【必须】在本次回复中强制执行【每日一次】的庇护所升级投掷。在`<Analysis>`中清晰地记录你模拟的1-100的点数，并根据结果决定是否使用`_.add('庇护所.庇护所等级[0]', 1);`。无论结果如何，都【必须】使用`_.set`更新`今日投掷点数`变量为 '今日已投掷: XX点 (升级/未升级)'。
      - '庇护所能力': 庇护所升级后，必须严格参照`<庇护所升级能力>`世界书条目，使用`_.assign('庇护所.庇护所能力[0]', ...)`指令添加新的能力对象。
    - **角色通用状态逻辑 (对所有角色生效):**
    - **【强制性全面扫描】:** 以下规则适用于【所有`登场状态`为'登场'的角色】。在每次互动后，你【必须】对列表中的每一个登场角色都进行下述检查，并更新所有发生变化的变量，【绝对不允许遗漏任何一个角色】，尤其是那些在本轮未与{{user}}直接互动的背景角色，为 '离场' 的角色则不需要进行 '衣着'、 '舌唇'、'胸乳'、'私穴'、'神态样貌'、 '动作姿势' 的更新，但是最少要更新 '健康' 这一参数。
      - **'健康'**: AI应根据事件严重性（如获得食物、药品、温暖环境，或遭受殴打、刺伤、疾病、饥饿等）合理判断数值变化，并使用`_.add`指令更新。**在使用`_.add`或`_.set`指令后，AI必须在内部逻辑中二次校验，确保最终计算出的值【绝对不能超过100】。如果计算结果大于100，则【必须强制将其值设为100】。**
      - **'健康更新原因'**: 每次'健康'值更新时，必须同步更新此项，格式为`'+/-X, 原因描述'`。
      - **'健康状况'**: 当'健康'值跨越阈值（80, 60, 30）时，必须更新此文本状态。
      - **'年龄'**: 当'世界.日期'的年份变更时，使用`_.add`指令为角色的年龄增加1。
      - **'衣着', '舌唇', '胸乳', '私穴', '神态样貌', '动作姿势'**: 当角色的身体状态、穿着或姿态因互动发生显著变化时，必须详细、具体地更新对应的描述文本。
      - **'内心想法'**: 在几乎每一次有意义的互动后，都必须更新此项，以第一人称视角反映角色最即时的、真实的内心活动。
      - **'登场状态'**: 当一个角色在当前及可预见的未来叙述中【完全不出现】时（例如已死亡、已离开且剧情焦点完全转移），将其状态更新为'离场'。只要角色在剧情中【有任何形式的存在感】（包括剧情中被提及、在后台活动），就必须保持'登场'状态。
    - **临时NPC逻辑【极重要】:**
      - **登场时:** 当一个新的临时NPC出现，你【必须】使用多个`_.set`指令，将`临时NPC`对象下的所有变量（'姓名'、'年龄'、'健康'、'健康状况'、'衣着'、 '舌唇'、'胸乳'、'私穴'、'神态样貌'、 '动作姿势'等）从初始的'无'或0，更新为该NPC的实际数据。同时将'登场状态'设为'登场'。
      - **离场时:** 当该临时NPC离场，你【必须】再次使用多个`_.set`指令，将`临时NPC`对象下的【所有】变量，全部重置回其初始值（'无', 0, '离场'），以完全清空数据槽，为下一个临时NPC的登场做准备。
    - **背景氛围渲染 (强制):** 在【每一次】生成`<UpdateVariable>`代码块时，你【必须至少用一句话】来更新`楼层其他住户`的“言语”或“行为”变量，以持续、动态地渲染出庇护所之外那绝望、混乱的末日背景氛围，除非剧情焦点已明确离开公寓楼。

  output_format: |-
    <UpdateVariable>
        <Analysis>
            - 互动分析与变量变更决策...
            - 检查世界时间...
            - 检查庇护所状态...
            - 检查浅见亚美状态...
            - ...
            - 检查临时NPC状态...
        </Analysis>
        _.set('${路径}', ${旧值}?, ${新值});//${原因}
        _.add('${路径}', ${增减值});//${原因}
        _.assign('${路径}', ${键或索引}?, ${值});//${原因}
        _.remove('${路径}', ${键或索引或值}?);//${原因}
    </UpdateVariable>

  example: |-
    <UpdateVariable>
        <Analysis>
            - Time has passed.
            - A new temporary NPC, a scavenger girl named '小雨', appeared.
            - She was injured during a dispute, her health decreased.
            - Her mental state is fearful.
            - The shelter leveled up to Lvl 5, unlocking 'Eden Pods'.
            - Asami Ami's status is stable, no change.
        </Analysis>
        _.set('世界.时间[0]', '早晨 - 09:10', '早晨 - 09:30'); //时间流逝20分钟
        ...
        _.set('临时NPC.姓名[0]', '无', '小雨'); //新的临时NPVC登场
        _.set('临时NPC.登场状态[0]', '离场', '登场'); //状态更新为登场
        _.add('临时NPC.健康[0]', -15); //她在争夺物资时被推倒，手臂擦伤
        _.set('临时NPC.健康更新原因[0]', '无', '-15, 摔倒导致手臂擦伤流血'); //更新健康变化原因
        ...
        _.set('临时NPC.神态样貌[0]', '无', '脸上布满灰尘，眼神惊恐，像只受惊的小鹿'); //更新神态
        _.set('临时NPC.内心想法[0]', '无', '这里面……好暖和……他会杀了我吗？还是……会给我吃的？'); //更新内心想法
        ...
        _.add('庇护所.庇护所等级[0]', 1); //庇护所升级
        _.assign('庇护所.庇护所能力[0]', { "name": "🏘️“伊甸荚舱”制造模块🏘️", "desc": "一项专为确立您领袖地位而设的核心能力。您可以在扩展区制造可部署的“伊甸荚舱”..." }); //添加新的庇护所能力
        ...
    </UpdateVariable>
---
</MVU AI核心指令>