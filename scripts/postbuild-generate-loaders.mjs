import fs from 'node:fs';
import path from 'node:path';

const DIST_ROOT = path.join(process.cwd(), 'dist');

if (!fs.existsSync(DIST_ROOT)) {
  process.exit(0);
}

const htmlFiles = fs.globSync('dist/**/index.html', { windowsPathsNoEscape: true });

const LOADER_SOURCE = `// Auto-generated by scripts/postbuild-generate-loaders.mjs
// Loads the sibling index.html, injects its styles, and re-executes its module scripts.

const __th_loaded = (globalThis.__tavern_helper_inline_loaders__ ??= new Set());
const __th_key = import.meta.url;
if (__th_loaded.has(__th_key)) {
  // Prevent double-mount if the user pastes the loader twice.
  // eslint-disable-next-line no-useless-return
  return;
}
__th_loaded.add(__th_key);

const indexUrl = new URL('./index.html', import.meta.url);

(async () => {
  const html = await fetch(indexUrl).then(r => r.text());
  const doc = new DOMParser().parseFromString(html, 'text/html');

  // Inject styles into the real <head> (style tags inside <body> also work, but this is cleaner).
  doc.querySelectorAll('head > style, head > link[rel=\"stylesheet\"]').forEach(node => {
    document.head.appendChild(node);
  });

  // Inject body content.
  document.body.append(...doc.body.childNodes);

  // Re-run module scripts as real modules (jQuery .load/.html can mis-handle module evaluation).
  doc.querySelectorAll('script[type=\"module\"]').forEach(src => {
    const s = document.createElement('script');
    s.type = 'module';
    if (src.src) s.src = src.src;
    s.textContent = src.textContent;
    document.body.appendChild(s);
  });
})().catch(err => console.error('[tavern_helper_template loader] Failed:', err));
`;

let generated = 0;

for (const htmlFile of htmlFiles) {
  const outDir = path.dirname(path.join(process.cwd(), htmlFile));
  const loaderPath = path.join(outDir, 'loader.js');

  // Always (re)generate so it's present after webpack output.clean.
  fs.writeFileSync(loaderPath, LOADER_SOURCE, 'utf8');
  generated += 1;
}

console.info(`[postbuild] generated ${generated} loader.js file(s)`);

