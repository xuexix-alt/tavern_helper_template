# MVU Zod 系统概述

## 系统定义

MVU Zod 是一个基于 Zod Schema 的变量管理框架，用于实现角色和世界的动态性。该系统通过 Zod 提供类型安全和运行时验证，使用 JSON Patch 标准进行变量更新，使角色和世界能够根据故事进展展现不同的行为模式和状态。

**核心特性**：
- **类型安全**：基于 Zod 4.x 的 Schema 定义
- **运行时验证**：所有变量更新都经过 Schema 验证
- **标准化更新**：使用 JSON Patch (RFC 6902) 标准
- **幂等操作**：支持增量更新和可重复解析

---

## 核心组件

MVU Zod 系统由以下6个核心模块组成：

### 模块1.0：变量结构设计（Zod 脚本）

**功能**：使用 Zod Schema 定义变量的结构、类型和验证规则

**格式**：JavaScript 脚本文件

**特点**：
- 使用 Zod 4.x 定义变量结构
- 提供类型安全和运行时验证
- 支持增量更新和幂等操作
- 为后续的变量初始化和更新提供结构约束

**输出文件**：`变量结构.js`

**相关文档**：[1.0.变量结构设计(脚本).md](1.0.变量结构设计(脚本).md)

---

### 模块1.1：变量初始化

**功能**：为 Zod Schema 中定义的变量生成符合类型约束的初始值

**格式**：YAML 格式

**特点**：
- 基于模块1.0的 Schema 生成初始值
- 仅包含变量名和初始值
- 所有值必须符合 Schema 定义的类型
- 不包含更新规则（更新规则在模块2）

**输出文件**：`变量初始化.yaml`

**相关文档**：[1.1.变量初始化条目.md](1.1.变量初始化条目.md)

---

### 模块2：变量更新规则

**功能**：为 Zod Schema 中定义的变量制定更新规则

**格式**：YAML 格式，结构化描述

**特点**：
- 基于 Schema 定义制定更新逻辑
- `type`：变量类型（string 类型可省略）
- `format`、`range`、`category` 等可选字段
- `check`：触发更新的条件和规则
- 支持合并相似规则（如 `${六维}`）
- 省略自明变量，保持简洁

**输出文件**：`变量更新规则.yaml`

**相关文档**：[2.变量更新规则.md](2.变量更新规则.md)

---

### 模块3：变量处理指令集

**功能**：向 AI 展示变量状态并提供标准化的更新指令格式

**格式**：YAML 格式

**核心内容**：
- 显示当前所有变量的状态值（`{{format_message_variable::stat_data}}`）
- 引用变量更新规则，指导 AI 判断更新时机
- 规定标准的输出格式（Analysis + JSONPatch）
- 使用 JSON Patch (RFC 6902) 标准进行变量更新

**更新操作**：
- `replace` - 替换现有值
- `add` - 添加新项到数组或对象
- `remove` - 删除项

**输出文件**：`变量处理指令集.yaml`

**相关文档**：[3.变量处理指令集.md](3.变量处理指令集.md)

---

### 模块4：动态内容展示

**功能**：根据变量值动态调整内容

**实现方式**：使用 EJS 条件判断，基于变量状态选择不同的内容

**应用场景**：
- **4.1 分阶段角色设定**：好感度变化、故事进展等触发的角色行为差异
- **4.2 动态世界内容**：场景描述、事件触发、内心独白等

**相关文档**：
- [4.1.分阶段角色设定.md](4.1.分阶段角色设定.md)
- [4.2.动态世界内容.md](4.2.动态世界内容.md)

---

### 模块5：HTML状态展示

**功能**：为用户提供直观的变量状态可视化界面

**特点**：
- 实时显示重要变量的当前值
- 进度条、文本等多种展示方式
- 增强用户沉浸感

**相关文档**：[5.html状态栏.md](5.html状态栏.md)

---

## 工作流程

MVU Zod 系统的完整工作流程包含6个阶段：

1. **变量结构设计（模块1.0）** - 使用 Zod Schema 定义变量的类型、结构和验证规则
2. **变量初始化（模块1.1）** - 基于 Schema 生成符合类型约束的初始值
3. **更新规则设计（模块2）** - 为每个变量定义更新时机和更新逻辑
4. **指令集配置（模块3）** - 建立 AI 感知变量状态和输出 JSON Patch 更新命令的机制
5. **动态内容设定（模块4）** - 基于变量值配置动态角色行为或世界内容
6. **状态可视化（模块5）** - 为用户提供直观的系统状态展示

---

## 系统优势

### 类型安全与验证

- **Zod Schema**：提供强类型定义和运行时验证
- **幂等操作**：支持增量更新，确保 `Schema.parse(Schema.parse(data)) === Schema.parse(data)`
- **自动修正**：使用 `z.transform` 进行容错处理，而非直接拒绝

### 标准化更新

- **JSON Patch (RFC 6902)**：使用工业标准的更新格式
- **灵活操作**：支持 `replace`、`add`、`remove` 三种操作
- **精确定位**：使用 JSON Pointer 路径定位变量

### 模块化设计

- **各组件职责清晰**：便于独立维护和扩展
- **关注点分离**：结构定义、初始化、更新规则、指令执行相互独立
- **高度可配置**：支持复杂的变量依赖关系和条件逻辑
- **CLI 工作流**：文件间依赖关系清晰，易于自动化

---

## Zod Schema 设计要点

### 幂等操作原则

Schema 设计必须支持增量更新，确保：
```javascript
Schema.parse(Schema.parse(input)) === Schema.parse(input)
```

### 类型定义规范

- **数字类型**：优先使用 `z.coerce.number()` 自动转换
- **对象优于数组**：使用 `z.record()` 而非 `z.array()`，便于通过键访问
- **容错优先**：使用 `z.transform()` 进行修正，而非直接拒绝
- **默认值**：使用 `prefault()` 而非 `default()`

### 约束和验证

- 仅在用户明确要求时才添加验证约束
- 使用 `z.transform()` 进行范围限制（如 `_.clamp(value, 0, 100)`）
- 避免使用 `.min()`、`.max()` 等会抛出错误的验证方法

---

## JSON Patch 更新规范

### 路径格式

使用 JSON Pointer (RFC 6901) 格式：
- 使用 `/` 分隔路径
- 数组索引用数字：`/记忆/0`
- 数组末尾用 `-`：`/记忆/-`
- 对象键直接使用：`/络络/亲密度`

### 操作类型

- `replace` - 替换现有值
- `add` - 向数组末尾添加或向对象添加新键
- `remove` - 删除数组项或对象键

---

## CLI 工作流程

### 文件依赖关系

```
模块1.0 → 变量结构.js
         ↓
模块1.1 → 变量初始化.yaml
         ↓
模块2 → 变量更新规则.yaml
         ↓
模块3 → 变量处理指令集.yaml
```

### 使用说明

1. **顺序执行**：按照模块顺序依次生成文件
2. **文件读取**：后续模块需读取前置模块生成的文件
3. **一致性**：修改前置模块后需重新生成后续模块

---

## 重要提示

**理解概念**：此文档用于理解 MVU Zod 系统的整体架构和工作原理。

**模块化使用**：各功能模块基于此框架进行构建，理解核心框架是高效使用的基础。

**类型安全**：所有操作都经过 Zod Schema 验证，确保数据一致性和正确性。
