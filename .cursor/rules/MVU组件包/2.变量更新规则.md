# 模块2：变量更新规则生成指令

## 模块定义

本模块负责为 Zod Schema 中定义的变量制定更新规则。这些规则与变量初始化分离，为 AI 提供清晰的变量更新逻辑指导。

**格式**：YAML 格式，为每个变量定义类型、范围和检查条件

**优势**：与初始化分离，便于维护和修改更新逻辑

**前置依赖**：
- 模块1.0（变量结构设计脚本）- 提供 Zod Schema 定义
- 模块1.1（变量初始化）- 提供初始值参考

---

## 生成任务

读取 `变量结构.js` 文件，基于其中的 Schema 定义，为变量制定合理的更新规则。

**操作步骤**：
1. 使用 Read 工具读取 `变量结构.js` 文件
2. 分析 Schema 中的变量结构和类型
3. 根据变量特性制定相应的更新规则
4. 如果文件不存在，提示用户先完成模块1.0

---

## YAML 格式规范

### 基本结构

```yaml
---
变量更新规则:
  ${变量名}:
    type: ${变量类型，如果是 string 则省略此字段}
    ${其他合适字段，仅在非常需要时才添加，如 format、range、category 等}
    check:
      - ${更新规则1}
      - ${更新规则2}
```

### 字段说明

- **`type`**：变量的数据类型
  - **如果是 `string` 类型，省略此字段**（字符串是默认类型）
  - 基础类型：`number`、`boolean`
  - 复杂类型：使用 TypeScript 类型定义或 Zod Schema（使用 `|-` 字符串块）
  - 示例：
    ```yaml
    type: number
    ```
    或
    ```yaml
    type: |-
      {
        名称: string;
        数量: number;
      }
    ```

- **可选字段**（仅在需要时添加）：
  - **`format`**：字符串格式约束（如 `${xx历}-${YYYY/MM/DD}-${HH:MM}`）
  - **`range`**：数值范围（如 `0~100`）
  - **`category`**：数值分段说明（如 `20~40: 普通人`）
  - **`value`**：字段含义说明

- **`check`**：变量更新的检查条件和规则
  - 每个条件占一行
  - 描述何时更新、如何更新
  - **尽量简练**，不要过度扩展情况
  - 仅列出关键的更新时机

---

## 编写原则

### 1. 合并相似规则

对于类型相同、更新规则相似的变量，可以合并为一条规则，使用占位符表示。

**注意区分固定键和动态键**：

#### 固定键（`z.object({...})`、`z.record(z.enum(...), ...)`）
键总是存在，可以直接使用占位符合并：

**示例**：
- `主角.能力面板.力量`、`主角.能力面板.敏捷`、`主角.能力面板.体质`、`主角.能力面板.感知`、`主角.能力面板.意志`、`主角.能力面板.魅力`... 可合并为 `主角.能力面板.${六维}`
- `${变量}.主角评价` 可统一定义所有"主角评价"字段的规则

#### 动态键（`z.record(z.string(), ...)`）
键可能为空或动态变化，应将键部分放入 `type` 的索引签名中：

**示例**：
```yaml
物品栏:
  type: |-
    {
      [物品名: string]: {
        数量: number;
        描述: string;
      }
    }
  check:
    - 获得、使用、丢弃物品时更新
```

### 2. 嵌套相同对象的字段

将相同对象的字段嵌套在一起，减少 token 消耗并提高可读性。

**示例**：
- 由于 `主角.能力面板` 和 `主角.装备栏` 都是 `主角` 对象的字段，应将它们嵌套在 `主角` 映射下

### 3. String 类型省略

字符串类型的变量可以省略 `type` 字段。

### 4. 省略自明变量

对于名称自解释的变量，如果没有特殊规则，可以省略不写（除非 Explorer 明确指定了特殊规则）。

**示例**：
- `当前位置`、`当前时间` 等字段，如果更新逻辑显而易见，无需列出

### 5. 避免冗余字段

仅在非常需要时才添加 `format`、`range`、`category` 等字段，保持规则简洁。

---

## 示例模板

**注意**：以下示例展示了推荐的编写风格，实际应根据 Schema 中定义的变量进行编写。

```yaml
---
变量更新规则:
  世界:
    当前时间:
      format: ${xx历}-${YYYY/MM/DD}-${HH:MM}
      check:
        - 每次事件推进、休息或旅行后更新，保持时间流逝合理
        - 若场景跳转跨度较大，应说明跳跃原因

  主角:
    能力面板.${六维}.数值:
      type: number
      range: 0~100
      category:
        20~40: 普通人
        40~70: 冒险者常驻
      check:
        - 训练、战斗、重伤、系统奖励等显著事件才调整
        - 单次变化不超过 ±10，除非剧情有明确强化/削弱

    装备栏.${部位}:
      type: |-
        {
          装备: string; // 装备名称 + 状态; 若未装备，使用"空置"或"无"
          主角评价: string;
        }
      check:
        - 穿戴、损毁、替换装备时更新装备描述

  任务列表:
    type: |-
      {
        [任务名: string]: {
          类型: '主线' | '支线' | '每日' | '临危受命' ;
          说明: string; # 面向主角的任务背景或细则
          目标: string; # 明确可执行的目标描述，可包含步骤
          奖励: string;
          惩罚: string; # 失败后触发的负面效果
        }
      }
    check:
      - 避免一次性添加超过3个主线任务，保持焦点
      - 日常任务完成后可重置但需记录冷却

  ${变量}.主角评价:
    value: 主角对某个变量内容的即时感受
    check:
      - 在对应变量值发生变化或遭遇相关事件后可更新，其他情况不应更新
      - 语言应保持第一人称/贴近主角口吻
      - 主角的评价并不会被主角本人看到，也不会在剧情中出现
```

---

## 输出要求

### 1. 读取文件

首先使用 Read 工具读取 `变量结构.js` 文件，分析其中的 Schema 定义。

如果文件不存在，提示：
```
找不到 `变量结构.js` 文件，请先使用模块1.0（变量结构设计脚本）生成 Zod Schema。
```

### 2. 主体内容

基于 Schema 定义，生成 YAML 格式的变量更新规则：

```yaml
---
变量更新规则:
  ${变量名}:
    type: ${类型，string 可省略}
    ${其他字段...}
    check:
      - ${更新规则}
```

**生成要求**：
- 包含在 `<context>` 标签和 ` ``` yaml` 代码块中
- 遵循上述编写原则
- 合并相似规则
- 省略自明变量
- String 类型省略 `type` 字段
- 保持简洁，避免冗余


#### c. 规则优化建议

"定期审查规则，删除不必要的条目，合并相似规则，保持文件简洁易维护。"

---

## 生成指令

生成内容后，使用 Write 工具将 YAML 规则定义保存到 `[mvu_update]变量更新规则.yaml` 文件中。

---

## 重要提醒

- **读取 Schema**：必须先读取 `变量结构.js` 了解变量结构
- **合并规则**：相似变量使用占位符合并（如 `${六维}`）
- **简洁性**：省略自明变量和冗余字段
- **灵活性**：根据用户的具体要求调整规则内容
